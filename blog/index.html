<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸ªäººåšå®¢</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <nav class="navbar">
        <div class="logo">Blog</div>
        <div class="nav-actions">
            <button title="é€šçŸ¥">ğŸ””</button>
            <button title="æœç´¢">ğŸ”</button>
            <div class="user-avatar" id="nav-visitor-avatar"></div>
        </div>
    </nav>

    <!-- ä¸»å®¹å™¨ -->
    <div class="main-container">
        <!-- ä¾§è¾¹æ  - åšä¸»èµ„æ–™ -->
        <aside class="sidebar">
            <div class="profile-card">
                <div class="profile-cover"></div>
                <div class="profile-info">
                    <div class="profile-avatar" id="blogger-avatar">
                        <!-- å¤´åƒ -->
                    </div>
                    <div class="profile-name">
                        <span id="blogger-display-name"></span>
                        <span class="verified-badge" id="verified-badge" style="display: none;">âœ“</span>
                    </div>
                    <div class="profile-username" id="blogger-username"></div>
                    <div class="profile-bio" id="blogger-bio"></div>
                    <div class="profile-location" id="blogger-location"></div>
                    <div class="profile-stats">
                        <div class="stat-item">
                            <div class="stat-number" id="stat-followers"></div>
                            <div class="stat-label">ç²‰ä¸</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="stat-following"></div>
                            <div class="stat-label">å…³æ³¨</div>
                        </div>
                    </div>
                </div>
                <div class="profile-actions">
                    <button class="btn-message" onclick="openChat()">
                        ğŸ’¬ å‘ç§ä¿¡
                    </button>
                </div>
            </div>
        </aside>

        <!-- æ–‡ç« åˆ—è¡¨ -->
        <main class="posts-container" id="posts-container">
            <!-- æ–‡ç« ç”± JS åŠ¨æ€ç”Ÿæˆ -->
        </main>
    </div>

    <!-- ç§ä¿¡çª—å£ -->
    <div class="chat-overlay" id="chat-overlay">
        <div class="chat-window">
            <div class="chat-header">
                <div class="avatar" id="chat-blogger-avatar"></div>
                <div class="info">
                    <div class="name" id="chat-blogger-name"></div>
                    <div class="status" id="chat-status"></div>
                </div>
                <button class="chat-close" onclick="closeChat()">Ã—</button>
            </div>
            <div class="chat-messages" id="chat-messages">
                <!-- æ¶ˆæ¯ç”± JS åŠ¨æ€ç”Ÿæˆ -->
                <div class="typing-indicator" id="typing-indicator">
                    <span>.</span><span>.</span><span>.</span> æ­£åœ¨è¾“å…¥
                </div>
                <div class="no-reply-notice" id="no-reply-notice"></div>
            </div>
            <div class="chat-input-container">
                <input type="text" class="chat-input" id="chat-input" placeholder="è¾“å…¥æ¶ˆæ¯..." onkeypress="handleChatKeypress(event)">
                <button class="chat-send" id="chat-send" onclick="sendMessage()">â¤</button>
            </div>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        // ========== å…¨å±€çŠ¶æ€ ==========
        let replyCount = 0;
        const config = BLOG_CONFIG;

        // ========== å·¥å…·å‡½æ•° ==========
        function formatNumber(num) {
            if (num >= 10000) {
                return (num / 10000).toFixed(1) + 'ä¸‡';
            }
            return num.toLocaleString();
        }

        function getInitial(name) {
            return name.charAt(0).toUpperCase();
        }

        function createAvatarElement(src, name, size = 44) {
            const container = document.createElement('div');
            if (src) {
                const img = document.createElement('img');
                img.src = src;
                img.alt = name;
                img.onerror = function() {
                    this.parentElement.innerHTML = `<div class="avatar-placeholder" style="width:${size}px;height:${size}px;">${getInitial(name)}</div>`;
                };
                container.appendChild(img);
            } else {
                container.innerHTML = `<div class="avatar-placeholder" style="width:${size}px;height:${size}px;">${getInitial(name)}</div>`;
            }
            return container.innerHTML;
        }

        // ========== åˆå§‹åŒ–é¡µé¢ ==========
        function initPage() {
            const blogger = config.blogger;
            const visitor = config.visitor;

            // è®¾ç½®é¡µé¢æ ‡é¢˜
            document.title = `${blogger.displayName} çš„ä¸ªäººåšå®¢`;

            // è®¾ç½®å¯¼èˆªæ è®¿å®¢å¤´åƒ
            document.getElementById('nav-visitor-avatar').textContent = getInitial(visitor.displayName);

            // è®¾ç½®åšä¸»èµ„æ–™
            const bloggerAvatarEl = document.getElementById('blogger-avatar');
            bloggerAvatarEl.innerHTML = createAvatarElement(blogger.avatar, blogger.displayName, 80);

            document.getElementById('blogger-display-name').textContent = blogger.displayName;
            document.getElementById('blogger-username').textContent = '@' + blogger.name;
            document.getElementById('blogger-bio').textContent = blogger.bio;
            document.getElementById('blogger-location').textContent = blogger.location;

            if (blogger.verified) {
                document.getElementById('verified-badge').style.display = 'flex';
            }

            document.getElementById('stat-followers').textContent = formatNumber(blogger.followers);
            document.getElementById('stat-following').textContent = formatNumber(blogger.following);

            // è®¾ç½®ç§ä¿¡çª—å£å¤´éƒ¨
            document.getElementById('chat-blogger-avatar').innerHTML = createAvatarElement(blogger.avatar, blogger.displayName);
            document.getElementById('chat-blogger-name').textContent = blogger.displayName;
            document.getElementById('chat-status').textContent = config.chat.bloggerStatus;
            if (config.chat.bloggerOnline) {
                document.getElementById('chat-status').classList.add('online');
            }

            // æ¸²æŸ“æ–‡ç« 
            renderPosts();

            // åˆå§‹åŒ–ç§ä¿¡å†å²
            initChatHistory();
        }

        // ========== æ¸²æŸ“æ–‡ç«  ==========
        function renderPosts() {
            const container = document.getElementById('posts-container');
            const blogger = config.blogger;
            const visitor = config.visitor;

            config.posts.forEach(post => {
                const postEl = document.createElement('article');
                postEl.className = 'post-card';
                postEl.id = `post-${post.id}`;

                // ç”Ÿæˆè¯„è®º HTML
                let commentsHtml = '';
                post.comments.forEach(comment => {
                    const isVisitor = comment.username === visitor.name;
                    commentsHtml += `
                        <div class="comment-item">
                            <div class="comment-avatar">${createAvatarElement(comment.avatar, comment.username, 36)}</div>
                            <div class="comment-body">
                                <div class="comment-username ${isVisitor ? 'is-visitor' : ''}">${comment.username}</div>
                                <div class="comment-text">${comment.content}</div>
                                <div class="comment-meta">
                                    <span>${comment.time}</span>
                                    <button class="like-btn">â¤ ${comment.likes}</button>
                                </div>
                            </div>
                        </div>
                    `;
                });

                // ç”Ÿæˆå›¾ç‰‡ HTML
                let imagesHtml = '';
                if (post.images && post.images.length > 0) {
                    imagesHtml = `
                        <div class="post-images">
                            <img src="${post.images[0]}" alt="æ–‡ç« å›¾ç‰‡" onerror="this.outerHTML='<div class=\\'placeholder\\'>[ å›¾ç‰‡ä½ç½® ]</div>'">
                        </div>
                    `;
                }

                postEl.innerHTML = `
                    <div class="post-header">
                        <div class="avatar">${createAvatarElement(blogger.avatar, blogger.displayName)}</div>
                        <div class="info">
                            <div class="name">
                                ${blogger.displayName}
                                ${blogger.verified ? '<span class="verified-badge">âœ“</span>' : ''}
                            </div>
                            <div class="meta">${post.publishDate} ${post.publishTime}</div>
                        </div>
                    </div>
                    <div class="post-content">
                        <h2 class="post-title">${post.title}</h2>
                        <div class="post-text">${post.content}</div>
                        ${imagesHtml}
                    </div>
                    <div class="post-stats">
                        <span>ğŸ‘ ${formatNumber(post.views)} æµè§ˆ</span>
                        <span>â¤ ${formatNumber(post.likes)} å–œæ¬¢</span>
                        <span>ğŸ’¬ ${post.comments.length} è¯„è®º</span>
                    </div>
                    <div class="post-actions">
                        <button class="${post.liked ? 'liked' : ''}" onclick="toggleLike(${post.id}, this)">
                            ${post.liked ? 'â¤' : 'ğŸ¤'} å–œæ¬¢
                        </button>
                        <button onclick="toggleComments(${post.id})">
                            ğŸ’¬ è¯„è®º
                        </button>
                        <button>
                            ğŸ”— åˆ†äº«
                        </button>
                    </div>
                    <div class="comments-section" id="comments-${post.id}" style="display: none;">
                        <div class="comments-header">è¯„è®º (${post.comments.length})</div>
                        ${commentsHtml}
                    </div>
                `;

                container.appendChild(postEl);
            });
        }

        // ========== äº¤äº’åŠŸèƒ½ ==========
        function toggleLike(postId, btn) {
            const post = config.posts.find(p => p.id === postId);
            if (post) {
                post.liked = !post.liked;
                if (post.liked) {
                    post.likes++;
                    btn.classList.add('liked');
                    btn.innerHTML = 'â¤ å–œæ¬¢';
                } else {
                    post.likes--;
                    btn.classList.remove('liked');
                    btn.innerHTML = 'ğŸ¤ å–œæ¬¢';
                }
                // æ›´æ–°ç»Ÿè®¡
                const statsEl = btn.closest('.post-card').querySelector('.post-stats span:nth-child(2)');
                statsEl.textContent = 'â¤ ' + formatNumber(post.likes) + ' å–œæ¬¢';
            }
        }

        function toggleComments(postId) {
            const commentsEl = document.getElementById(`comments-${postId}`);
            commentsEl.style.display = commentsEl.style.display === 'none' ? 'block' : 'none';
        }

        // ========== ç§ä¿¡åŠŸèƒ½ ==========
        function openChat() {
            document.getElementById('chat-overlay').classList.add('active');
            scrollChatToBottom();
            document.getElementById('chat-input').focus();
        }

        function closeChat() {
            document.getElementById('chat-overlay').classList.remove('active');
        }

        function initChatHistory() {
            const messagesContainer = document.getElementById('chat-messages');
            const visitor = config.visitor;
            const blogger = config.blogger;

            config.chat.history.forEach(msg => {
                addMessageToChat(msg.content, msg.sender === 'visitor', msg.time);
            });
        }

        function addMessageToChat(content, isSent, time = null) {
            const messagesContainer = document.getElementById('chat-messages');
            const typingIndicator = document.getElementById('typing-indicator');
            const noReplyNotice = document.getElementById('no-reply-notice');

            const msgEl = document.createElement('div');
            msgEl.className = `message ${isSent ? 'sent' : 'received'}`;
            msgEl.innerHTML = `
                ${content}
                ${time ? `<span class="time">${time}</span>` : ''}
            `;

            // æ’å…¥åˆ° typing indicator ä¹‹å‰
            messagesContainer.insertBefore(msgEl, typingIndicator);
            scrollChatToBottom();
        }

        function scrollChatToBottom() {
            const messagesContainer = document.getElementById('chat-messages');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function getCurrentTime() {
            const now = new Date();
            const month = now.getMonth() + 1;
            const day = now.getDate();
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            return `${month}æœˆ${day}æ—¥ ${hours}:${minutes}`;
        }

        function sendMessage() {
            const input = document.getElementById('chat-input');
            const content = input.value.trim();

            if (!content) return;

            // æ·»åŠ å‘é€çš„æ¶ˆæ¯
            addMessageToChat(content, true, getCurrentTime());
            input.value = '';

            // æ£€æŸ¥æ˜¯å¦è¿˜èƒ½è‡ªåŠ¨å›å¤
            if (replyCount < config.chat.maxReplies) {
                // æ˜¾ç¤ºæ­£åœ¨è¾“å…¥
                const typingIndicator = document.getElementById('typing-indicator');
                typingIndicator.classList.add('active');
                scrollChatToBottom();

                // å»¶è¿Ÿåå‘é€è‡ªåŠ¨å›å¤
                const autoReply = config.chat.autoReplies[replyCount];
                setTimeout(() => {
                    typingIndicator.classList.remove('active');
                    addMessageToChat(autoReply.reply, false, getCurrentTime());
                    replyCount++;

                    // å¦‚æœè¾¾åˆ°æœ€å¤§å›å¤æ¬¡æ•°ï¼Œæ˜¾ç¤ºæç¤º
                    if (replyCount >= config.chat.maxReplies) {
                        setTimeout(() => {
                            const noReplyNotice = document.getElementById('no-reply-notice');
                            noReplyNotice.textContent = config.chat.noMoreReplyMessage;
                            noReplyNotice.classList.add('active');
                            scrollChatToBottom();
                        }, 2000);
                    }
                }, autoReply.delay);
            } else {
                // å·²ç»æ²¡æœ‰æ›´å¤šå›å¤äº†ï¼Œä½†å¯ä»¥ç»§ç»­å‘æ¶ˆæ¯
                // ä¸åšä»»ä½•è‡ªåŠ¨å›å¤
            }
        }

        function handleChatKeypress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // ç‚¹å‡»é®ç½©å±‚å…³é—­
        document.getElementById('chat-overlay').addEventListener('click', function(e) {
            if (e.target === this) {
                closeChat();
            }
        });

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', initPage);
    </script>
</body>
</html>
